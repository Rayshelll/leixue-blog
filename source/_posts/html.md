---
title: html
date: 2019-08-19 16:11:04
tags: 
- html
---
#### html 加载时发生了什么
（解析dom tree、生成样式结构体、构建render tree）
1. 浏览器把获取到的HTML代码解析成1个DOM树（包含HTML标签，包括display:none，还有用JS动态添加的元素等）
2. 浏览器把所有样式(用户定义的CSS和用户代理)解析成样式结构体.
3. DOM Tree 和样式结构体组合后构建render tree，render tree不包含隐藏的节点(比如display:none的节点，还有head节点)，`DOM Tree+ CSS = render tree`。

#### Repaint（重绘）和Reflow（重排）
- `repaint`：重绘render tree中的一些元素需要更新属性触发的浏览器行为，这些属性只是影响元素的外观，风格，而不会影响布局的。例如改变`background-color`、`visibility`、`outline`、透明度等属性。浏览器会根据元素的新属性重新绘制，使元素呈现新的外观。重绘不会带来重新布局，并不一定伴随回流。

- `reflow`：重排是更明显的一种改变，元素的内容、结构、位置、布局，隐藏、动画、尺寸发生了变化，**需要重新计算样式和render tree**，这个过程称为Reflow。重排一定会引起浏览器的重绘，会影响排版。对脱离文档流的元素和隐藏的元素`display:none`操作不会引起重排。

- 常见的引起回流的具体操作：
    1. Initial，网页初始化的时候
    2. Resize调整窗口大小；
    3. 改变字体大小；
    4. 样式表改动；
    5. 元素内容变化，尤其是输入控件；
    6. CSS伪类激活；
    7. js在操作DOM；
    8. offsetWidth, width, clientWidth, scrollTop/scrollHeight的计算， 会使浏览器将渐进回流队列Flush，立即执行回流

- 减少重绘和回流就是要减少对渲染树的操作：
    1. 将多次改变样式属性的操作合并成一次操作。
    2. 将需要多次回流的元素，position属性设为absolute或fixed，这样此元素就脱离了文档流，它的变化不会影响到其他元素。例如有动画效果的元素就最好设置为绝对定位。
    3. 由于display属性为none的元素不在渲染树中，对隐藏的元素操作不会引发其他元素的重排。如果要对一个元素进行复杂的操作时，可以先隐藏它，操作完成后再显示。

#### html5标签语义化
语义化标签也能让浏览器更好的读取页面结构
``` html
<header> <!--头部可以定义多个、但不能作为<address>、<footer> 或 <header> 元素的子元素-->
<h1>-<h6>
<button>
<nav><!--导航栏、可定义多个<nav>元素-->
<main><!--主要区域，一个文档中不能出现多个<main>标签-->
<section> <!--区块（有语义化的div），表示文档中的一个区域（或节）-->
<article> <!--主要内容，格局比section大-->
<aside><!--侧边栏-->
<footer> <!--底部-->
```
语义化的优点：
- 易于用户阅读，样式丢失的时候能让页面呈现清晰的结构。
- 有利于SEO，和搜索引擎建立良好沟通，搜索引擎根据标签来确定上下文和各个关键字的权重。
- 方便其他设备解析（如屏幕阅读器、盲人阅读器、移动设备）根据语义渲染网页
- 有利于开发和维护，语义化更具可读性，代码更好维护。

#### 前端优化性能
1. 资源压缩合并，减少HTTP请求
2. 非核心代码异步加载
    - 动态脚本加载
    - defer（在html解析完毕才执行,如果有多个则按加载顺序执行）
    - async （加载完毕后立即执行,如果是多个,执行顺序与加载顺序无关）
3. 利用浏览器缓存
    - 对于多次http请求的数据，用localStorage或者sessionStorage进行缓存
4. 使用CDN（内容分发网络）
    - 静态资源尽量使用 CDN 加载，CDN 加载静态资源需要注意 CDN 域名要与主站不同，否则每次请求都会带上主站的 Cookie，平白消耗流量
5. 预解析DNS
    - 通过预解析的方式来预先获得域名所对应的 IP
    ``` js
    <link rel="dns-prefetch" href="//yuchengkai.cn">
    ```
6. 文件优化
    - 图片优化，压缩，css样式替换icon
    - CSS 文件放在 head 中
    - 将 script 标签放在 body 底部，因为 JS 文件执行会阻塞渲染。最后加载

#### 从输入URL到页面渲染完成
从输入URL到渲染出整个页面的过程包括三个部分：
1. DNS解析URL的过程（将域名解析成ip地址）
    1. 从浏览器缓存中查询。浏览器会存储一定时间的DNS记录，操作系统不会告诉浏览器每个DNS记录的保存时限，不同浏览器设置保存时限为一个固定值（不同浏览器情况不同，一般在2-30分钟）。
    2. 从操作系统缓存中查询。如果浏览器中没有包含想要的缓存记录，那浏览器就会发起操作系统请求，继续查询操作系统缓存
    3. 从路由器中查询DNS缓存。请求持续发送到你的路由，它通常会有自己的DNS缓存。
    4. 从ISP中查询DNS缓存。下一个被查询地方是ISP缓存DNS的服务器。
    5. 域名服务器递归查询。首先从root域名服务器中查询如.com域名服务器，然后逐步向前查询，.com顶级域名服务器到Facebook的域名服务器。一般来说，.com级别的都已经在缓存中了，所以一般不会进行对root域名服务器的查询。下面给出一张递归查询的图。
2. 浏览器发送请求与服务器交互的过程
    1. 浏览器根据解析到的IP地址和端口号发起`http`请求。http请求包括header和body。header中包括请求的方式（get和post）、请求的协议 （http、https、ftp）、请求的地址ip、缓存cookie。body中有请求的内容。
    2. http请求到达传输层，利用tcp协议与服务器建立连接（`三次握手`）
    3. 服务器接收到http请求之后，处理请求，处理完的结果以HTTP的Response对象返回，主要包括状态码，响应头，响应报文三个部分。
    4. 浏览器接收到返回的响应体，为服务器返回给浏览器的信息，主要由HTML，css，js，图片文件组成，若状态码显示成功，开始进行页面的渲染
3. 浏览器对接收到的html页面渲染的过程
    1. 浏览器深度遍历把html节点遍历成dom 树
    2. 将css解析成CSS DOM树
    3. 将dom树和CSS DOM树构造成render树
    4. 根据得到的render树 计算样式和渲染树（回流）
    5. 遍历render树并调用硬件API绘制所有节点（重绘）
4. 关闭TCP连接或继续保持连接（四次挥手）
    - 通过四次挥手关闭连接(FIN ACK, ACK, FIN ACK, ACK)。

#### HTML5那些新增属性
html5新增：`canvas`绘画，本地离线存储`localStorage`，`sessionStorage`，跨域`window.postMessage`API，`video`和`audio`元素，语义化元素，表单类型（`date`，`time`，`email`等），地理定位等等

#### 前端一般主要的一些漏洞或者是场景
1. SQL 注入攻击(SQL Injection)
对输入字符串中夹带的 SQL 指令的检查，那么这些夹带进去的指令就会被数据库误认为是正常的 SQL 指令而运行，从而使数据库受到攻击，可能导致数据被窃取、更改、删除，以及进一步导致网站被嵌入恶意代码、被植入后门程序等危害。
解决方法：对进入数据库的特殊字符 '"\<>&*; 等进行转义处理，或编码转换。
2. 跨站脚本攻击(Cross Site Scripting, XSS)
跨站脚本攻击(Cross Site Scripting, XSS)发生在客户端，可被用于进行窃取隐私、钓鱼欺骗、偷取密码、传播恶意代码等攻击行为。 恶意的攻击者将对客户端有危害的代码放到服务器上作为一个网页内容， 使得其他网站用户在观看此网页时，这些代码注入到了用户的浏览器中执行，使用户受到攻击。一般而言，利用跨站脚本攻击，攻击者可窃会话 Cookie 从而窃取网站用户的隐私
解决办法：
- 对参数做 html 转义过滤，要过滤的字符包括：单引号、双引号、大于号、小于号，& 符号，防止脚本执行。
- 在变量输出时进行 HTML ENCODE 处理。
3. CSRF 漏洞
跨站请求伪造(Cross-Site Request Forgery, CSRF)，恶意网站通过脚本向当前用户浏览器打开的其它页面的 URL 发起恶意请求，由于同一浏览器进程下 Cookie 可见性，导致用户身份被盗用，完成恶意网站脚本中指定的操作。
解决方法：
验证请求是信任页面发起，这类修复方案有：
- 在表单中填充一次性随机的 csrf token 防止攻击者伪造 form 表单进行 CSRF。同时将此串 token 置入 session，在后端再进行一次一致性校验。
referer 验证。
验证请求是合法用户发起，这类修复方案有：
- 验证码
- 密码验证
- OTP 验证

#### 懒加载的原理
核心原理是：
1. 设置一个定时器，计算每张图片是否会随着滚动条的滚动，而出现在视口（也就是浏览器中的 展现网站的空白部分 ）中；
2. 为`<img>`标签设置一个暂存图片URL的自定义属性（例如loadpic），当图片出现在视口时，再将loadpic的值赋给图片的src属性；